# ライブラリ統合優先度分析（V3計画）

## 📊 設計文書vs実装ギャップの詳細分析

### 🔥 **Critical（必須）- V3で必須実装**

#### 1. **ngc-learn** (推奨度: ★★★★★)
- **設計文書での位置づけ**: 「メインの予測符号化実装」
- **現状**: ❌ 完全未実装
- **影響**: 設計文書の根幹要件が未達成
- **実装状況**: ✅ アダプターパターン実装済み（`ngc_learn_adapter.py`）
- **V3優先度**: 🔥 **最高優先度**

```python
# 設計文書の想定使用法
import ngclearn as ngc
class PredictiveCodingCore(eqx.Module):
    # ngc-learnを使用した実装が必須
```

#### 2. **PyHGF** (推奨度: ★★★★☆) 
- **設計文書での用途**: 「ベイズ推論の厳密な実装」
- **現状**: 基本確率分布のみ、階層ベイズなし
- **影響**: ベイズ推論の理論的厳密性不足
- **V3優先度**: 🔥 **高優先度**

### ⚠️ **High（重要）- V3で推奨実装**

#### 3. **minisom** (推奨度: ★★★☆☆)
- **設計文書での用途**: 「自己組織化」ライブラリ
- **現状**: requirements.txtに記載済みだが未使用
- **実装**: ✅ 自前JAX SOM実装でカバー済み
- **V3優先度**: ⚠️ **中優先度**（自前実装で代替可能）

#### 4. **PRECO** (推奨度: ★★★★☆)
- **設計文書での用途**: 「補助的な実装、比較検証」
- **現状**: 完全未実装
- **影響**: 実装比較・検証機能なし
- **V3優先度**: ⚠️ **中優先度**（研究目的）

### ✅ **Low（対応済み）- V3で活用拡大**

#### 5. **numpyro** (推奨度: 記載あり)
- **現状**: ✅ インストール済み、活用可能
- **V3計画**: PyHGF代替として活用強化

#### 6. **distrax** (推奨度: 記載あり) 
- **現状**: ✅ インストール済み、活用可能
- **V3計画**: 確率分布処理で活用強化

#### 7. **diffrax** (推奨度: 記載あり)
- **現状**: ✅ インストール済み、未活用
- **V3計画**: 連続時間ダイナミクスで活用

---

## 🎯 V3統合ロードマップ

### **フェーズ1: Critical実装（2-3週間）**

#### **Week 1-2: NGC-Learn完全統合**
```python
# 目標実装
class ProductionNGCLearnCore(PredictiveCodingCore):
    """本格的なNGC-Learn統合実装"""
    
    def __init__(self):
        # 実際のNGC frameworkを使用
        self.ngc_network = ngc.Network([
            ngc.PCNode(...),  # 実際のNGC nodes
            ngc.PCNode(...),
        ])
    
    def forward_prediction(self, input_data):
        # NGC-Learnの生物学的妥当な処理
        return self.ngc_network.predict(input_data)
```

**成功基準**:
- ✅ NGC-Learnの実際のインストール・動作確認
- ✅ 生物学的妥当性のある予測符号化実装
- ✅ 既存JAX実装との性能比較
- ✅ 100%後方互換性維持

#### **Week 3: PyHGF階層ベイズ統合**
```python
# 目標実装
import pyhgf

class HierarchicalBayesianCore:
    """PyHGFを使用した厳密な階層ベイズ推論"""
    
    def __init__(self):
        self.hgf = pyhgf.HGF(...)  # 階層ガウシアンフィルター
    
    def bayesian_update(self, observations):
        # 厳密なベイズ更新
        return self.hgf.update(observations)
```

### **フェーズ2: High実装（1-2週間）**

#### **MiniSOM統合・比較検証**
- 自前JAX実装 vs MiniSOM性能比較
- 研究用途での検証機能追加

#### **PRECO比較実装**
- 研究・論文執筆用の比較検証システム
- PyTorch vs JAX実装比較

### **フェーズ3: 活用拡大（継続）**

#### **既存インストール済みライブラリの活用強化**
- **numpyro**: PyHGF補完の確率的プログラミング
- **distrax**: 高度な確率分布処理
- **diffrax**: 連続時間予測符号化

---

## 📈 実装戦略の詳細

### **1. Adapter Pattern による段階的統合**

```python
# V3統合アーキテクチャ
class V3PredictiveCodingSystem:
    """V3完全統合システム"""
    
    def __init__(self):
        # コア実装（必須）
        self.ngc_core = NGCLearnCore()        # ★★★★★
        self.bayesian_core = PyHGFCore()      # ★★★★☆
        
        # 比較・検証（研究用）
        self.preco_core = PRECOCore()         # ★★★★☆
        self.minisom_core = MiniSOMCore()     # ★★★☆☆
        
        # 既存システム（互換性保持）
        self.jax_core = JAXPredictiveCodingCore()  # 後方互換性
        self.som_integration = SOMPredictiveIntegration()  # V2機能
```

### **2. 設計文書100%実現の確認項目**

| 要素 | 設計文書要求 | V2状況 | V3目標 | 実装方法 |
|------|-------------|--------|--------|----------|
| **予測符号化** | ngc-learn使用 | JAX自前 | NGC-Learn統合 | アダプター統合 |
| **階層ベイズ** | PyHGF水準 | 基本のみ | 厳密実装 | PyHGF/numpyro |
| **自己組織化** | minisom使用 | JAX SOM | 両方活用 | 比較検証 |
| **時間ダイナミクス** | diffrax使用 | 離散時間 | 連続時間 | diffrax活用 |

### **3. 後方互換性保証戦略**

```python
# V3でも既存コードが100%動作
class BackwardCompatibilityGuarantee:
    """後方互換性保証クラス"""
    
    @staticmethod
    def test_v1_compatibility():
        # V1 APIが完全動作
        pass
    
    @staticmethod  
    def test_v2_compatibility():
        # V2 SOM統合が完全動作
        pass
    
    @staticmethod
    def test_v3_enhancements():
        # V3新機能が追加機能として動作
        pass
```

---

## 🏆 V3完成時の達成目標

### **定量的目標**
- **設計文書実現率**: 90% → **100%**
- **推奨ライブラリ統合**: 30% → **90%**
- **テストカバレッジ**: 140% → **150%**

### **質的目標**
- ✅ **理論的完全性**: 設計文書の全要件実装
- ✅ **生物学的妥当性**: NGC-Learnによる神経科学準拠
- ✅ **数学的厳密性**: PyHGFによる階層ベイズ
- ✅ **実用性**: 後方互換性100%維持

### **学術的価値**
- エナクティビズム理論の完全計算実装
- 最新神経科学研究との整合性
- 国際的な意識研究への貢献

### **技術的価値**
- Clean Architecture + 最新AI実装の統合事例
- 大規模ライブラリ統合のベストプラクティス
- 段階的移行戦略の成功モデル

---

## 🚨 実装上の注意点

### **Critical Issues**

1. **NGC-Learn依存性管理**
   - CUDA要件の確認
   - バージョン互換性の維持
   - インストールエラーのハンドリング

2. **PyHGF数学的複雑性**
   - 階層ベイズの計算コスト
   - 数値安定性の確保
   - JAXとの統合最適化

3. **性能最適化**
   - 複数ライブラリ統合による性能影響
   - メモリ使用量管理
   - 並列処理最適化

### **Risk Mitigation**

```python
# リスク軽減策
class V3RiskMitigation:
    """V3実装リスク軽減"""
    
    def __init__(self):
        # フォールバック機構
        self.fallback_engines = {
            'ngc-learn': JAXPredictiveCodingCore,
            'pyhgf': NumpyroBasicBayesian,
            'preco': JAXComparativeImplementation
        }
    
    def safe_initialization(self, preferred_engine):
        try:
            return preferred_engine()
        except ImportError:
            return self.fallback_engines[preferred_engine.__name__]()
```

---

## 📋 次のアクションアイテム

### **即座実行項目**
1. ✅ NGC-Learn実際のインストール・動作テスト
2. ✅ PyHGF環境セットアップ
3. ✅ V3統合テストスイート設計

### **V3開発開始準備**
1. 📋 NGC-Learn学習・API調査
2. 📋 PyHGF数学的理解・実装計画
3. 📋 統合アーキテクチャの詳細設計

**V3で、ついに設計文書の完全実現が達成されます！** 🎯✨